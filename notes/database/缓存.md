# 缓存
- 缓存的三种策略
    - Cache Aside Pattern 旁路缓存模式
    - Read/Write through Pattern 读写穿透模式
    - Write behind Pattern 异步缓存写入

<br>

- 旁路缓存模式
    - 写：先更新DB，然后直接失效缓存
    - 读：查询缓存，如果缓存存在，返回结果。如果缓存中不存在，读取DB，返回结果，并把返回的结果写入Cache
    - 无论先操作数据库还是先操作缓存，都会存在脏数据的情况。

- 读写穿透模式
    - 在旁路缓存模式下，应用层去和缓存和数据库打交道，增加了应用层的复杂度，在读写穿透模式下，应用层之和缓存打交道，由缓存去操作和维护数据库。
    - 写：读取缓存，(1)缓存未命中，缓存去更新数据库，数据库返回结果，缓存返回更新成功。(2)缓存命中，更新缓存，缓存更新数据库，数据库返回结果，缓存返回更新成功。
    - 读：读取缓存，(1)缓存命中，返回结果。(2)缓存未命中，缓存去查询数据库，写入缓存，缓存返回结果。

- 异步缓存写入模式
    - 读写穿透模式每次更新数据都回去同时写入数据库，数据写入速度会比较慢。
    - 异步缓存写入模式会在一段时间之后异步的将数据批量写入数据库。优点：(1)应用层只写缓存，速度快。(2)缓存在异步的写入数据库的时候会将多个I/O操作合并为一个，减少I/O次数。
    - 缺点：复杂度高，更新后的数据如果没写入数据库，遇到断电问题会导致数据丢失。

<br>

- 如何保证数据库与缓存的一致性
    - 可以引入分布式事务来解决，常见的有：2PC、TCC、MQ事务消息等。但是引入分布式事务，会带来性能上的影响。
    - 在实际的使用中，通常不会去保证cache和DB的强一致性，而是允许两者在短暂时间内的不一致，保证两者的最终一致性。
    - 最终一致性的常用方案如下：(1)更新数据库，数据库产生binlog，监听和消费binlog，执行实现缓存操作。如果失效缓存失败，引入重试机制，将失败的数据通过MQ的方式进行重试。